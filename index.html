<script>
  const FORM_ACTION_URL = "https://docs.google.com/forms/d/e/1FAIpQLSfKukLzJSq9hQEk8l4rB4lRtvAT6S2xBUfHZFeDyPxwv649SQ/formResponse";
  const ENTRY_ID = "entry.686525639";

  const statusEl = document.getElementById("status");
  const btn = document.getElementById("btn");

  let qr;
  let lastSent = "";

  function setStatus(msg) { statusEl.textContent = msg; }
  function normalizeUrl(u) { return String(u).trim().replace(/\|/g, "%7C"); }

  function sendToForm(link) {
    const form = document.getElementById("hiddenForm");
    const input = document.getElementById("hiddenInput");
    form.action = FORM_ACTION_URL;
    input.name = ENTRY_ID;
    input.value = link;
    form.submit();
  }

  async function start() {
    if (qr) return;
    btn.disabled = true;
    setStatus("Abrindo câmera… (checando permissão/dispositivos)");

    try {
      const cameras = await Html5Qrcode.getCameras();
      if (!cameras || cameras.length === 0) {
        throw new Error("Nenhuma câmera encontrada ou permissão negada.");
      }

      const backCam = cameras.find(c => /back|traseira|environment/i.test(c.label));
      const cameraId = (backCam || cameras[0]).id;

      setStatus("Câmera encontrada. Iniciando…");
      qr = new Html5Qrcode("reader");

      await qr.start(
        cameraId,
        { fps: 10, qrbox: 250 },
        (decodedText) => {
          const link = normalizeUrl(decodedText);
          if (link === lastSent) return;
          lastSent = link;

          setStatus("Lido:\n" + link + "\n\nSalvando na planilha…");
          sendToForm(link);

          qr.stop().then(() => {
            qr.clear();
            qr = null;
            btn.disabled = false;
            setStatus("✅ Salvo! Aperte 'Iniciar câmera' para o próximo recibo.");
          });
        },
        () => {}
      );

      setStatus("Aponte para o QR Code…");
    } catch (e) {
      setStatus("❌ Falha ao abrir câmera:\n" + (e && e.message ? e.message : e));
      qr = null;
      btn.disabled = false;
    }
  }

  btn.addEventListener("click", start);
</script>
