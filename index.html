<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Scanner NFC-e → Planilha</title>
  <script src="https://unpkg.com/html5-qrcode@2.3.10"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 16px; text-align:center; }
    #reader { width: 100%; max-width: 420px; margin: 12px auto; }
    button { padding: 12px 16px; font-size: 16px; }
    .status { margin-top: 12px; font-size: 14px; white-space: pre-wrap; }
    .small { font-size: 12px; opacity: 0.8; }
  </style>
</head>
<body>
  <h2>Escanear QR da NFC-e</h2>
  <p>Ao ler, o link é salvo automaticamente na sua planilha (via Google Forms).</p>

  <div id="reader"></div>
  <button id="btn">Iniciar câmera</button>
  <div class="status" id="status"></div>
  <div class="small">Dica: use a câmera traseira e boa iluminação.</div>

  <!-- Envio sem CORS: form escondido + iframe -->
  <iframe name="hidden_iframe" style="display:none;"></iframe>
  <form id="hiddenForm" target="hidden_iframe" method="POST" style="display:none;">
    <input id="hiddenInput" name="" value="" />
  </form>

  <script>
    const FORM_ACTION_URL = "https://docs.google.com/forms/d/e/1FAIpQLSfKukLzJSq9hQEk8l4rB4lRtvAT6S2xBUfHZFeDyPxwv649SQ/formResponse";
    const ENTRY_ID = "entry.686525639";

    const statusEl = document.getElementById("status");
    const btn = document.getElementById("btn");

    let qr;
    let lastSent = "";

    function setStatus(msg) { statusEl.textContent = msg; }

    function normalizeUrl(u) {
      // Corrige pipes | (SP) se vierem crus
      return String(u).trim().replace(/\|/g, "%7C");
    }

    function sendToForm(link) {
      const form = document.getElementById("hiddenForm");
      const input = document.getElementById("hiddenInput");

      form.action = FORM_ACTION_URL;
      input.name = ENTRY_ID;
      input.value = link;

      form.submit();
    }

    async function start() {
      if (qr) return;

      setStatus("Abrindo câmera…");
      btn.disabled = true;

      qr = new Html5Qrcode("reader");

      try {
        await qr.start(
          { facingMode: "environment" },
          { fps: 10, qrbox: 250 },
          (decodedText) => {
            const link = normalizeUrl(decodedText);

            // Evita enviar duplicado se o QR for lido várias vezes
            if (link === lastSent) return;
            lastSent = link;

            setStatus("Lido:\n" + link + "\n\nSalvando na planilha…");
            sendToForm(link);

            // Para a câmera após salvar (você pode recarregar pra próximo)
            qr.stop().then(() => {
              setStatus("✅ Salvo! Recarregue a página para escanear outro recibo.");
              qr = null;
              btn.disabled = false;
            });
          },
          () => {}
        );

        setStatus("Aponte para o QR Code…");
      } catch (e) {
        setStatus("❌ Erro ao iniciar câmera:\n" + e);
        btn.disabled = false;
        qr = null;
      }
    }

    btn.addEventListener("click", start);
  </script>
</body>
</html>
